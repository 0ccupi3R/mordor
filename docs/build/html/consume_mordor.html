

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Consume Mordor Data &mdash; Mordor 0.0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Licenses" href="license.html" />
    <link rel="prev" title="Network Configuration" href="network_config.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Mordor
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Mordor Environment:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="network_design.html">Network Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="network_config.html">Network Configurations</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting Started:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Mordor Data Consumption</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#kafkacat-style">Kafkacat Style</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#requirements">Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="#consume-logs">Consume Logs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#jupyter-notebook-style">Jupyter Notebook Style</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">Consume Logs</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Licenses:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="license.html">GNU General Public License V3</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Mordor</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Consume Mordor Data</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/consume_mordor.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="consume-mordor-data">
<h1>Consume Mordor Data<a class="headerlink" href="#consume-mordor-data" title="Permalink to this headline">¶</a></h1>
<a class="reference internal image-reference" href="_images/catapult-main-image.png"><img alt="Catapult" src="_images/catapult-main-image.png" style="width: 747.0px; height: 336.0px;" /></a>
<p>You can simply download the json files available in this repo and start using some grep fu! if you feel like it.
However, there are other more efficient ways you can consume the pre-recorded data and even simulate a real data pipeline to ingest the data to your own SIEM or data lake.</p>
<div class="section" id="kafkacat-style">
<h2>Kafkacat Style<a class="headerlink" href="#kafkacat-style" title="Permalink to this headline">¶</a></h2>
<p>You can start using a tool named Kafkacat to act as a Kafka producer and send data to Kafka brokers. You can just grab the logs from this repo and re-play the data as if it was being ingested in real-time.</p>
<div class="section" id="requirements">
<h3>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference external" href="http://kafka.apache.org/">Kafka Broker</a> : A distributed publish-subscribe messaging system that is designed to be fast, scalable, fault-tolerant, and durable.</li>
<li><a class="reference external" href="https://github.com/edenhill/kafkacat">Kafkacat</a> : A generic non-JVM producer and consumer for Apache Kafka &gt;=0.8, think of it as a netcat for Kafka.</li>
<li><a class="reference external" href="https://www.elastic.co/elk-stack">HELK (Basic Option)</a> : An elastic ELK (Elasticsearch, Logstash, Kibana) stack.</li>
<li><a class="reference external" href="https://docs.docker.com/install/">Docker CE</a> : Docker Community Edition (CE) is ideal for developers and small teams looking to get started with Docker and experimenting with container-based apps (<code class="docutils literal notranslate"><span class="pre">Installed</span> <span class="pre">by</span> <span class="pre">HELK</span></code>).</li>
<li><a class="reference external" href="https://docs.docker.com/compose/">Docker Compose</a> : a tool for defining and running multi-container Docker applications (<code class="docutils literal notranslate"><span class="pre">Installed</span> <span class="pre">by</span> <span class="pre">HELK</span></code>).</li>
</ul>
<a class="reference internal image-reference" href="_images/kafka-kafkacat.png"><img alt="Kafkacat Infrastructure" src="_images/kafka-kafkacat.png" style="width: 699.65px; height: 327.25px;" /></a>
</div>
<div class="section" id="consume-logs">
<h3>Consume Logs<a class="headerlink" href="#consume-logs" title="Permalink to this headline">¶</a></h3>
<p>You can start by installing Kafkacat following the <a class="reference external" href="https://github.com/edenhill/kafkacat#install">instructions from the official Kafkacat repo</a>.</p>
<p>Download and run the <a class="reference external" href="https://github.com/Cyb3rWard0g/HELK">HELK</a>. Make sure you have enough memory to run the basic build.
You can run it with 5-6GB of RAM now (More information <a class="reference external" href="https://github.com/Cyb3rWard0g/HELK/wiki/Installation">here</a>.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> git clone https://github.com/Cyb3rWard0g/HELK.git
<span class="gp">$</span> <span class="nb">cd</span> HELK/docker
<span class="gp">$</span> sudo ./helk_install
</pre></div>
</div>
<p>Use the defaults (Option 1 and Basic license)</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">**********************************************</span>
<span class="go">**          HELK - THE HUNTING ELK          **</span>
<span class="go">**                                          **</span>
<span class="go">** Author: Roberto Rodriguez (@Cyb3rWard0g) **</span>
<span class="go">** HELK build version: v0.1.7-alpha02262019 **</span>
<span class="go">** HELK ELK version: 6.6.1                  **</span>
<span class="go">** License: GPL-3.0                         **</span>
<span class="go">**********************************************</span>

<span class="go">[HELK-INSTALLATION-INFO] HELK being hosted on a Linux box</span>
<span class="go">[HELK-INSTALLATION-INFO] Available Memory: 12541 MBs</span>
<span class="go">[HELK-INSTALLATION-INFO] You&#39;re using ubuntu version xenial</span>

<span class="go">*****************************************************</span>
<span class="go">*      HELK - Docker Compose Build Choices          *</span>
<span class="go">*****************************************************</span>

<span class="go">1. KAFKA + KSQL + ELK + NGNIX + ELASTALERT</span>
<span class="go">2. KAFKA + KSQL + ELK + NGNIX + ELASTALERT + SPARK + JUPYTER</span>

<span class="go">Enter build choice [ 1 - 2]: 1</span>
<span class="go">[HELK-INSTALLATION-INFO] HELK build set to 1</span>
<span class="go">[HELK-INSTALLATION-INFO] Set HELK elastic subscription (basic or trial): basic</span>
<span class="go">[HELK-INSTALLATION-INFO] Set HELK IP. Default value is your current IP: 192.168.64.138</span>
<span class="go">[HELK-INSTALLATION-INFO] Set HELK Kibana UI Password: hunting</span>
<span class="go">[HELK-INSTALLATION-INFO] Verify HELK Kibana UI Password: hunting</span>
<span class="go">[HELK-INSTALLATION-INFO] Installing htpasswd..</span>
<span class="go">[HELK-INSTALLATION-INFO] Installing docker via convenience script..</span>
<span class="go">[HELK-INSTALLATION-INFO] Installing docker-compose..</span>
<span class="go">[HELK-INSTALLATION-INFO] Checking local vm.max_map_count variable and setting it to 4120294</span>
<span class="go">[HELK-INSTALLATION-INFO] Building &amp; running HELK from helk-kibana-analysis-basic.yml file..</span>
</pre></div>
</div>
<p>Download the mordor repo and choose your technique:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">cd</span> ../../
<span class="gp">$</span> git clone https://github.com/Cyb3rWard0g/mordor.git
<span class="gp">$</span> <span class="nb">cd</span> mordor/small_datasets/windows/credential_access/credential_dumping_T1003/credentials_from_ad/
</pre></div>
</div>
<p>Decompress the specific mordor log file</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> tar -xzvf empire_dcsync.tar.gz
<span class="go">x empire_dcsync_2019-03-01174830.json</span>
</pre></div>
</div>
<p>Send the data to HELK via Kafcakat with the following flags:</p>
<dl class="function">
<dt>
<code class="descname">-b</code></dt>
<dd><p>Kafka Broker</p>
</dd></dl>

<dl class="function">
<dt>
<code class="descname">-t</code></dt>
<dd><p>Topic in the Kafka Broker to send the data to</p>
</dd></dl>

<dl class="function">
<dt>
<code class="descname">-P</code></dt>
<dd><p>Producer mode</p>
</dd></dl>

<dl class="function">
<dt>
<code class="descname">-l</code></dt>
<dd><p>Send messages from a file separated by delimiter, as with stdin. (only one file allowed)</p>
</dd></dl>

<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> kafkacat -b &lt;HELK IP&gt;:9092 -t winlogbeat -P -l empire_dcsync_2019-03-01174830.json
</pre></div>
</div>
<p>Browse to your Kibana Discover view and start going through the data</p>
<a class="reference internal image-reference" href="_images/mordor-dcsync-logs.png"><img alt="DCSync" src="_images/mordor-dcsync-logs.png" style="width: 717.0px; height: 407.0px;" /></a>
<p>You could look for potential DCSync actvity from a non-Domain-Controller account with the following query in Kibana:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>event_id:4662 NOT user_name:*$ AND object_properties:(&quot;*1131f6aa-9c07-11d1-f79f-00c04fc2dcd2*&quot; OR &quot;*1131f6ad-9c07-11d1-f79f-00c04fc2dcd2*&quot; OR &quot;*89e95b76-444d-4c62-991a-0facbeda640c*&quot;)
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/mordor-dcsync-found.png"><img alt="DCSync Found" src="_images/mordor-dcsync-found.png" style="width: 706.0px; height: 410.0px;" /></a>
</div>
</div>
<div class="section" id="jupyter-notebook-style">
<h2>Jupyter Notebook Style<a class="headerlink" href="#jupyter-notebook-style" title="Permalink to this headline">¶</a></h2>
<p>You can consume mordor data directly with a Jupyter notebook and analyze it via python libraries such as Pandas.</p>
<div class="section" id="id1">
<h3>Requirements<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference external" href="https://docs.docker.com/install/">Docker CE</a> : Docker Community Edition (CE) is ideal for developers and small teams looking to get started with Docker and experimenting with container-based apps.</li>
<li><a class="reference external" href="https://jupyter.org/">Jupyter Notebook</a> : an open-source web application that allows you to create and share documents that contain live code, equations, visualizations and narrative text.</li>
</ul>
</div>
<div class="section" id="id3">
<h3>Consume Logs<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>Install docker by following the <a class="reference external" href="https://docs.docker.com/install/">official Docker instructions</a>.</p>
<p>Download the mordor repo</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> git clone https://github.com/Cyb3rWard0g/mordor.git
</pre></div>
</div>
<p>Run a HELK dockerized <strong>Jupyter Notebook</strong> server and mount your mordor folder to it with the following command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> docker run -p <span class="m">127</span>.0.0.1:8888:8888 --env <span class="nv">JUPYTER_TYPE</span><span class="o">=</span>notebook -v <span class="nv">$PWD</span>/mordor:/opt/helk/jupyter/notebooks/mordor -it cyb3rward0g/helk-jupyter:0.1.2
<span class="go">[HELK-JUPYTER-DOCKER-INSTALLATION-INFO] Starting Jupyter..</span>
<span class="go">[HELK-JUPYTER-DOCKER-INSTALLATION-INFO] Running Jupyter Type: notebook..</span>
<span class="go">[HELK-JUPYTER-DOCKER-INSTALLATION-INFO] Running the following parameters --ip=0.0.0.0 --port=8888 --notebook-dir=/opt/helk/jupyter/notebooks --no-browser --NotebookApp.base_url=/</span>
<span class="go">[I 03:27:32.369 NotebookApp] Writing notebook server cookie secret to /home/jupyter/.local/share/jupyter/runtime/notebook_cookie_secret</span>
<span class="go">[I 03:27:32.560 NotebookApp] JupyterLab extension loaded from /opt/conda/lib/python3.7/site-packages/jupyterlab</span>
<span class="go">[I 03:27:32.561 NotebookApp] JupyterLab application directory is /opt/conda/share/jupyter/lab</span>
<span class="go">[I 03:27:32.563 NotebookApp] Serving notebooks from local directory: /opt/helk/jupyter/notebooks</span>
<span class="go">[I 03:27:32.563 NotebookApp] The Jupyter Notebook is running at:</span>
<span class="go">[I 03:27:32.564 NotebookApp] http://(2e83a98485eb or 127.0.0.1):8888/?token=90311c8670ed2bd71f7d9e8378fdc39711ef65a0b3ed6296</span>
<span class="go">[I 03:27:32.564 NotebookApp] Use Control-C to stop this server and shut down all kernels (twice to skip confirmation).</span>
<span class="go">[C 03:27:32.568 NotebookApp]</span>

<span class="go">    To access the notebook, open this file in a browser:</span>
<span class="go">        file:///home/jupyter/.local/share/jupyter/runtime/nbserver-76-open.html</span>
<span class="go">    Or copy and paste one of these URLs:</span>
<span class="go">        http://(2e83a98485eb or 127.0.0.1):8888/?token=90311c8670ed2bd71f7d9e8378fdc39711ef65a0b3ed6296</span>
</pre></div>
</div>
<p>Browse to 127.0.0.1:8888 in your favorie browser and enter the token provided in the jupyter output above</p>
<a class="reference internal image-reference" href="_images/jupyter-login.png"><img alt="Jupyter login" src="_images/jupyter-login.png" style="width: 728.1px; height: 585.9px;" /></a>
<p>You will be taken to the Jupyter main interface</p>
<a class="reference internal image-reference" href="_images/jupyter-main-menu.png"><img alt="Jupyter main men" src="_images/jupyter-main-menu.png" style="width: 732.6px; height: 386.1px;" /></a>
<p>Create a new notebook with kernel <code class="docutils literal notranslate"><span class="pre">Python</span> <span class="pre">3</span></code></p>
<a class="reference internal image-reference" href="_images/jupyter-new-notebook.png"><img alt="Jupyter new notebook" src="_images/jupyter-new-notebook.png" style="width: 728.1px; height: 373.5px;" /></a>
<p>You can go through the directory tree of the mordor project and even hit [TAB] for auto-completion to get to a specific technique</p>
<p>Create a new notebook</p>
<a class="reference internal image-reference" href="_images/jupyter-list-dir.png"><img alt="Jupyter list mordor files" src="_images/jupyter-list-dir.png" style="width: 724.8px; height: 295.8px;" /></a>
<p>Decompress the mordor file you want to work with. Let’s pick a dcsync example.</p>
<a class="reference internal image-reference" href="_images/jupyter-decompress-file.png"><img alt="Jupyter decompress file" src="_images/jupyter-decompress-file.png" style="width: 712.1999999999999px; height: 322.2px;" /></a>
<p>Use pandas to read the file. You are ready to start exploring and analyzing the data</p>
<a class="reference internal image-reference" href="_images/jupyter-dcsync-logs.png"><img alt="Jupyter Pandas" src="_images/jupyter-dcsync-logs.png" style="width: 714.0px; height: 478.2px;" /></a>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="license.html" class="btn btn-neutral float-right" title="Licenses" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="network_config.html" class="btn btn-neutral float-left" title="Network Configuration" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Roberto Rodriguez, Jose Luis Rodriguez

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>